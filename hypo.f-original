      subroutine hypo

      include "global.h"
      include "malloc.h"

      integer ien(nen,nec),rng(neface,nec)
      real* 8 xn(nsd,nnc), x(nsd,nn_loc), xna(nsd,nn),hg(nec)
      pointer (rngptr,rng),(ienptr,ien)
      pointer (xnptr,xn),(xptr,x),(hgptr,hg),(xnaptr,xna)

      integer id(ndf,nnc) 
      real* 8 dn(ndf,nnc),fn(ndf,nnc)
      real* 8 d(ndf,nn_loc),do(ndf,nn_loc)
      real* 8 bg(ndf,nnc),dg(ndf,nnc),p(ndf,nn_loc)
      real* 8 wg(ndf,nnc), w(ndf,nn_loc)
      pointer (idptr,id),(fnptr,fn),(dnptr,dn)
      pointer (dptr,d),(doptr,do),(uptr,u)
      pointer (bgptr,bg),(dgptr,dg),(pptr,p)
      pointer (wgptr,wg),(wptr,w)

      real* 8 disp(nsd,nn_loc),dispn(nsd,nnc), kdg(nsd,nnc)
      real* 8 kp(nsd,nn_loc), kw(nsd,nn_loc), kid(nsd,nnc)
      real* 8 kbg(nsd,nnc), kzg(nsd*nnc), kwg(nsd,nnc)
      real* 8 e(nsd,nn_loc), err(nsd,nnc),xrefn(nsd,nnc)
      real* 8 xref(nsd,nn_loc),xrefold(nsd,nn_loc)
      real* 8 xrefnold(nsd,nnc),meshvel(nsd,nn_loc)
      real* 8 meshveln(nsd,nnc)
      pointer (dispptr,disp),(dispnptr,dispn),(kdgptr,kdg)
      pointer (kpptr,kp), (kwptr,kw), (kidptr,kid)
      pointer (kbgptr,kbg), (kzgptr,kzg),(kwgptr,kwg)
      pointer (eptr,e),(errptr,err),(xrefnptr,xrefn)
      pointer (xrefptr,xref),(xrefnoldptr,xrefnold)
      pointer (xrefoldptr,xrefold), (meshvelptr,meshvel)
      pointer (meshvelnptr,meshveln)

      real* 8 f(nsd,nsd,nec), finv(nsd,nsd,nec),finvtemp(nsd,nsd,nec)
      real* 8 jac(nec),jacinv(nec),jacinvtemp(nec)
      pointer (fptr,f),(finvptr,finv),(finvtempptr,finvtemp)
      pointer (jacptr,jac),(jacinvptr,jacinv),(jacinvtempptr,jacinvtemp)

      integer idf(nnc) 
      real* 8 dnf(nnc),fnf(nnc)
      real* 8 df(nn_loc),dof(nn_loc)
      real* 8 bgf(nnc),dgf(nnc),pf(nn_loc)
      real* 8 wgf(nnc), wf(nn_loc)
      pointer (idfptr,idf),(fnfptr,fnf),(dnfptr,dnf),(anfptr,anf)
      pointer (dfptr,df),(dofptr,dof),(afptr,af)
      pointer (bgfptr,bgf),(dgfptr,dgf),(pfptr,pf)
      pointer (wgfptr,wgf),(wfptr,wf)

      real* 8 dd(ndf+4,nnc),hn(nnc),hm(nn_loc)
      pointer (ddptr,dd),(hnptr,hn),(hmptr,hm)

      real* 8 z(ndf*nnc,inner)
      real* 8 v(ndf*nnc,inner+1)
      real* 8 zg(ndf*nnc), avg(ndf*nnc), sm(ndf*nnc)
      real* 8 vloc(ndf,nn_loc),avloc(ndf,nn_loc)
      pointer (zptr,z),(vptr,v)
      pointer (avgptr,avg),(zgptr,zg),(smptr,sm)
      pointer (vlocptr,vloc),(avlocptr,avloc)

      real* 8 zf(nnc,inner)
      real* 8 vf(nnc,inner+1)
      real* 8 zgf(nnc), avgf(nnc), smf(nnc)
      real* 8 vlocf(nn_loc),avlocf(nn_loc)
      pointer (zfptr,zf),(vfptr,vf)
      pointer (avgfptr,avgf),(zgfptr,zgf),(smfptr,smf)
      pointer (vlocfptr,vlocf),(avlocfptr,avlocf)

      real* 8 h(inner+1,inner)
      real* 8 y(inner+1)
      real* 8 cc(inner), ss(inner)
      pointer (hptr,h),(yptr,y),(ccptr,cc),(ssptr,ss)

      logical assemble
      integer ierr
      real* 8 length(nsd)
ccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccc
      call error("initialization",-999,.false.)
      tt = t_start
ccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccc
      call error("read ien",-999,.false.)
      ienptr = malloc(nen*nec*isize)
      call readien(ien)
ccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccc
      call error("communications",-999,.false.)
      call commsetup(ien)
c  call nodesetup (cnn,mn) !!!!change me

      xnptr = malloc(nnc*nsd*fsize)
      xptr = malloc(nn_loc*nsd*fsize)
      rngptr = malloc(nec*neface*isize)
      xnaptr= malloc(nn*nsd*fsize)
      hgptr = malloc(nec*fsize)

      idptr = malloc(nnc*ndf*isize)
      dnptr = malloc(nnc*ndf*fsize)
      fnptr = malloc(nnc*ndf*fsize)
      bgptr = malloc(nnc*ndf*fsize)
      dgptr = malloc(nnc*ndf*fsize)
      wgptr = malloc(nnc*ndf*fsize)
      dptr = malloc(nn_loc*ndf*fsize)
      uptr = malloc(nn_loc*nsd*fsize)
      doptr = malloc(nn_loc*ndf*fsize)
      pptr = malloc(nn_loc*ndf*fsize)
      wptr = malloc(nn_loc*ndf*fsize)

      idfptr = malloc(nnc*isize)
      dnfptr = malloc(nnc*fsize)
      fnfptr = malloc(nnc*fsize)
      anfptr = malloc(nnc*fsize)
      bgfptr = malloc(nnc*fsize)
      dgfptr = malloc(nnc*fsize)
      wgfptr = malloc(nnc*fsize)
      dfptr = malloc(nn_loc*fsize)
      afptr = malloc(nn_loc*fsize)
      dofptr = malloc(nn_loc*fsize)
      pfptr = malloc(nn_loc*fsize)
      wfptr = malloc(nn_loc*fsize)
      
      dispptr = malloc(nn_loc*nsd*fsize)
      dispnptr = malloc(nnc*nsd*fsize)
      kdgptr = malloc(nnc*nsd*fsize)
      kpptr = malloc(nn_loc*nsd*fsize)
      kwptr = malloc(nn_loc*nsd*fsize)
      kidptr = malloc(nnc*nsd*isize)
      kbgptr = malloc(nnc*nsd*fsize)
      kwgptr = malloc(nnc*nsd*fsize)
      kzgptr = malloc(nnc*nsd*fsize)
      errptr = malloc(nnc*nsd*fsize)
      eptr = malloc(nn_loc*nsd*fsize)
      xrefnptr = malloc(nnc*nsd*fsize)
      xrefptr = malloc(nn_loc*nsd*fsize)
      xrefnoldptr=malloc(nnc*nsd*fsize)
      xrefoldptr = malloc(nn_loc*nsd*fsize)
      meshvelptr = malloc(nn_loc*nsd*fsize)
      meshvelnptr = malloc(nnc*nsd*fsize)

      fptr = malloc(nsd*nsd*nec*fsize)
      finvptr = malloc(nsd*nsd*nec*fsize)
      jacptr = malloc(nec*fsize)
      jacinvptr = malloc(nec*fsize)
      finvtempptr = malloc(nsd*nsd*nec*fsize)
      jacinvtempptr = malloc(nec*fsize)

      ddptr = malloc((ndf+4)*nnc*fsize)
      hnptr = malloc(nnc*fsize)
      hmptr = malloc(nn_loc*fsize)

      hptr = malloc((inner+1)*inner*fsize)
      yptr = malloc((inner+1)*fsize)
      ccptr = malloc(inner*fsize)
      ssptr = malloc(inner*fsize)

      zptr = malloc(ndf*nnc*inner*fsize)
      vptr = malloc(ndf*nnc*(inner+1)*fsize)
      zgptr = malloc(ndf*nnc*fsize)
      avgptr = malloc(ndf*nnc*fsize)
      smptr = malloc(ndf*nnc*fsize)
      vlocptr = malloc(ndf*nn_loc*fsize)
      avlocptr = malloc(ndf*nn_loc*fsize)

      zfptr = malloc(nnc*inner*fsize)
      vfptr = malloc(nnc*(inner+1)*fsize)
      zgfptr = malloc(nnc*fsize)
      avgfptr = malloc(nnc*fsize)
      smfptr = malloc(nnc*fsize)
      vlocfptr = malloc(nn_loc*fsize)
      avlocfptr = malloc(nn_loc*fsize)

ccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccc
      call error("read x and rng",-999,.false.)
      call readx(xn)
      call readrng(rng)
      call error("diskout",-999,.false.)
ccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccc
      call readallx(xna)
      do isd=1,nsd
         length(isd)=maxval(xna(isd,1:nn))
      enddo
ccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccc

      call error("form d and id",-999,.false.)
      call formid(id,idf,rng,ien,hn,hm)
      call formd (xn,fn,fnf,rng,ien,hn,hm)
      call equal(fn ,dn ,ndf*nnc)
      call equal(fnf,dnf,nnc)
      if(restart) then
         call error("restart",-999,.false.)
         call diskin(xn,dn,dnf,dd)
      endif
      call setd(dn ,fn ,id ,ndf)
      call setd(dnf,fnf,idf,1)
      call equal(dnf,anf,nnc)
      call sharp(anf,nnc,1)
      call error("diskout",-999,.false.)
      call diskout(xn,dn,anf,dd)
ccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccc
      call error("local shape functions",-999,.false.)
      call shape
ccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccc
      call error("localization",-999,.false.)
      call gather (x,xn,nsd,hn,hm)
      call gather (d,dn,ndf,hn,hm)
      call gather (df,dnf,1,hn,hm)
ccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccc
      call error("mesh information",-999,.false.)
      call vol(x,ien,df)
      if (myid.eq.0) then
         write(7,*)' '
         write(7,'(" Volume of gas............ = ",e15.8)') gas
         write(7,'(" Volume of liquid......... = ",e15.8)') liq
      endif
      call lenght(x,ien,hg)
      if (myid.eq.0) then
         write(7,'(" Minimum element lenght... = ",e15.8)') hmin
         write(7,'(" Maximum element lenght... = ",e15.8)') hmax
         write(7,'(" Minimum element volume... = ",e15.8)') vmin
         write(7,'(" Maximum element volume... = ",e15.8)') vmax
      endif
ccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccc
      if (myid.eq.0) write (7,101) nq,nqf
ccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccc
      call equal(xn,xrefn,nsd*nnc)
      call equal(xrefn,xrefnold,nsd*nnc)
cccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccc
c  Starts Time Loop
cccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccc
      do its=1,nts
         if (myid.eq.0) write (6,*) ' '
         if (myid.eq.0) write (6,*) ' TIME STEP = ', its
         if (myid.eq.0) write (7,*) ' '
         if (myid.eq.0) write (7,*) ' TIME STEP = ', its
         tt = tt + dt
         call equal(d,do,ndf*nn_loc)
         call equal(df,dof,nn_loc)
         
cccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccc
c   Starts Mesh Update Iteration Loop
cccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccc
         call error("form dd and kid",-999,.false.)
         call formidm(kid,rng,ien,hn,hm)
         call formdm (xn,dispn,rng,ien,hn,hm,length)   
cccccccccccccccccccccccccccccccccccccccccccccccccccccccc
         call error("localization",-999,.false.)
         call gather (x,xn,nsd,hn,hm)
         call gather (disp,dispn,nsd,hn,hm)
cccccccccccccccccccccccccccccccccccccccccccccccccccccc
c   call fclear(kp,nsd*nn_loc)
c   call lump(x,ien,kp)
c   call scatter(kp,kzg,nsd,assemble,hn,hm)
c   call solerror (x,e,kbg,kp,ien,kzg,kwg)
         
         do iit=1,10            !change if necessary
            call fclear(kp,nsd*nn_loc)
            call fclear(kw,nsd*nn_loc)
            
            call blockm(x,e,disp,kw,kp,ien)
            assemble=.true.
            call scatter(kp,kbg,nsd,assemble,hn,hm)
            call scatter(kw,kwg,nsd,assemble,hn,hm)
            call setid(kbg,kid,nsd)
            call getnorm(kbg,kbg,nsd*nnc,res_l)
            res_l= sqrt(res_l/nq)
            if (res_l.lt.epsilon) goto 200
            call fclear(kdg,nsd*nnc)
            call gmresm(x,kid,kwg,kbg,kdg,ien,hn,hm,z,v,kzg,
     &           avg,sm, avloc,h,y,cc,ss)
            call getnorm(kdg,kdg,nsd*nnc,del_l)
            del_l = sqrt(del_l/nq)
            call update(kp, disp, kdg, nsd,hn,hm)
            if (myid.eq.0) write(6,102)iit,del_l,del_g
            if (myid.eq.0) write(7,102)iit,del_l,del_g
         enddo
 200     continue
         assemble=.false.
         call scatter(disp,dispn,nsd,assemble,hn,hm)
         call add(xrefn,xn,dispn,nsd)
         call gather(xref,xrefn,nsd,hn,hm)
c.... Calculate mesh velocity, vhat
         call mesvel(xrefn, xrefnold, meshveln)
         do i=1,nnc
         write(*,*) meshveln(1,nnc),meshveln(2,nnc),meshveln(3,nnc)
         enddo
         call equal(xrefn,xrefnold,nsd*nnc)
         call gather(meshvel,meshveln,nsd,hn,hm)
ccccccc...............end of mesh update..................cccccc


ccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccc
c......calculate d(x)/d(xref), deformation gradient
         call defgrad(x, xref,ien,f,jac,finv,jacinv)
c         call defgradinv(x,xref,ien,finv,jacinv)

ccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccc
         
         do iit=1,nit
ccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccc
            call equal(dof,df,nn_loc)
            call fclear(pf,nn_loc)
            call fclear(wf,nn_loc)
            call getu(d,do,u)
            call blockf(x,df,dof,u,pf,wf,hg,ien)
            assemble=.true.
            call scatter(pf,bgf,1,assemble,hn,hm)
            call scatter(wf,wgf,1,assemble,hn,hm)
            call setid(bgf,idf,1)
            call getnorm(bgf,bgf,nnc,res_g)
            res_g = sqrt(res_g/nqf)
            call fclear(dgf,nnc)
            call gmresf(x,u,idf,wgf,bgf,dgf,hg,ien,hn,hm,
     &           zf,vf,zgf,avgf,smf,vlocf,avlocf,h,y,cc,ss)
            call getnorm(dgf,dgf,nnc,del_g)
            del_g = sqrt(del_g/nqf)
            call update(pf, df, dgf, 1,hn,hm)
            call cut(df)
            call locate(x,ien,df)
            call sharp(df,nn_loc,0)
ccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccc
            call fclear(p,ndf*nn_loc)
            call fclear(w,ndf*nn_loc)
            call getfi(df,dof,af)
            call sharp(af,nn_loc,1)
            if(hydro.gt.0) call hydrostatic(x,af,p,rng,ien)
            call block(x,d,do,af,p,w,hg,ien)
            assemble=.true.
            call scatter(p,bg,ndf,assemble,hn,hm)
            call scatter(w,wg,ndf,assemble,hn,hm)
            call setid(bg,id,ndf)
            call getnorm(bg,bg,ndf*nnc,res_l)
            res_l= sqrt(res_l/nq)
            call fclear(dg,ndf*nnc)
            call gmres(x,d,do,id,af,wg,bg,dg,hg,ien,hn,hm,
     &           z,v,zg,avg,sm,vloc,avloc,h,y,cc,ss)
            call getnorm(dg,dg,ndf*nnc,del_l)
            del_l = sqrt(del_l/nq)
            call update(p, d, dg, ndf,hn,hm)

            if (myid.eq.0) write(6,102)iit,res_l,del_l,res_g,del_g
            if (myid.eq.0) write(7,102)iit,res_l,del_l,res_g,del_g
ccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccc
         end do
ccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccc
c..... Writing Output
ccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccc
         if(mod(its,ntsbout).eq.0) then
            if(surf(0).gt.0) call dyno(x,d,rng,ien)
            idisk = idisk+1
            assemble=.false.
            call scatter(d,dn,ndf,assemble,hn,hm)
            call scatter(df,dnf,1,assemble,hn,hm)
            call equal(dnf,anf,nnc)
            call sharp(anf,nnc,1)
            call diskout(xrefn,dn,anf,dd)
         endif
      end do
ccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccc
ccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccc
      if (myid.eq.0) then
         write(7,*)'Processors...............',numproc 
      endif
      
      return
      
 101  format(/"Number of equations for Flow.........(nq) = ",i10,
     &     /"Number of equations for Interface...(nqf) = ",i10)
 102  format("Iteration",i3,':  ',4e14.7)
      
      end
      
      

!cccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccc
!   FEM Navier Stokes fluid solver
!     incompressible, implicit
!cccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccc
	if (myid == 0) then
     write(*,*) "*** Solving Fluids: calculate fluid field ***"
	end if
    !...store the variables from the previous time step,dold=d 
     dold = d
     call formid(id,rng,ien)
     call formd(d,rng,ien)
     call formid_spbc(id,nn_spbc,spbcnode)

!===========================================================================
if (edge_inflow .ne. 0) then
! Apply nature boundary condition
if (myid == 0) then
write (*,*) 'Apply nature BC'
end if
        call nature_pre(x,d,ien,rng,bc4el,ne_inflow,edge_inflow,pin,p)
        f_fluids(1,:) =  f_fluids(1,:) + p(1,:)
end if

     do iit=1,nit
        res_pb(:,:)=0.0
        res_pb_temp(:,:)=0.0
        res_pb_w(:,:)=0.0
        res_pb_w_temp(:,:)=0.0

        p(:,:) = 0.0d0
        w(:,:) = 0.0d0
         call block(x,d,dold,p,w,hg,ien,f_fluids,rng,f_stress,&
		ne_intlocal,ien_intlocal,node_local,nn_local, &
		sur_fluid,I_fluid)
	call res_slipbc_precon(p,w,d,x,rng,ien,spbcnode,spbcele,ne_intlocal,ien_intlocal,I_fluid)
if(nn_pb.gt.0) then
        res_pb_temp(1:nsd,1:nn_pb)=p(1:nsd,pbnode(2,1:nn_pb))
	res_pb_w_temp(1:nsd,1:nn_pb)=w(1:nsd,pbnode(2,1:nn_pb))
	call mpi_barrier(mpi_comm_world,ierror)
	call mpi_allreduce(res_pb_temp(1,1),res_pb(1,1),nsd*nn_pb,mpi_double_precision, &
			mpi_sum,mpi_comm_world,ierror)
        call mpi_allreduce(res_pb_w_temp(1,1),res_pb_w(1,1),nsd*nn_pb,mpi_double_precision, &
                        mpi_sum,mpi_comm_world,ierror)
	call mpi_barrier(mpi_comm_world,ierror)
end if
        call communicate_res_ad(p,ndf,nn,send_address,ad_length)
        call communicate_res_ad(w,ndf,nn,send_address,ad_length)
if(nn_pb.gt.0) then
	p(1:nsd,pbnode(1,1:nn_pb))=p(1:nsd,pbnode(1,1:nn_pb))+res_pb(1:nsd,1:nn_pb)
	w(1:nsd,pbnode(1,1:nn_pb))=w(1:nsd,pbnode(1,1:nn_pb))+res_pb_w(1:nsd,1:nn_pb)
	p(1:nsd,pbnode(2,1:nn_pb))=0.0
end if

        call res_rotation(p,norm_node,nn_spbc,spbcnode)
        call res_rotation_precon(w,norm_node,nn_spbc,spbcnode)
        !...apply boundary conditions, calculate residual with corrected BC
        !...i.e. where id=0 -> p=0
          call setid_pa(p,ndf,nn,id,node_local,nn_local)


        !...calculate the normalized error, res_l
         call getnorm_pa(p,ndf,nn,node_local,nn_local,res_l)
         res_l= sqrt(res_l)
        !...calculate the increment(delta_d) for each degree of freedom, dg
         dg(:,:) = 0.0d0
        call gmres(x,d,dold,w,p,dg,hg,ien,f_fluids,id, &
		   ne_intlocal,ien_intlocal,node_local,nn_local, &
		   global_com,nn_global_com,local_com,nn_local_com,send_address,ad_length,&
		   sur_fluid,I_fluid,&
		   norm_node,spbcnode,spbcele,rng,pbnode) 	
        !...calculate the normalized increment, del_l
         call getnorm_pa(dg,ndf,nn,node_local,nn_local,del_l)
         del_l = sqrt(del_l)
        !...update the calculated variables, d=d+dg
	        call mpi_barrier(mpi_comm_world,ierror)

         call update(p, d, dg, ndf)

if(nn_pb.gt.0) then
d(1:nsd,pbnode(2,1:nn_pb))=d(1:nsd,pbnode(1,1:nn_pb))
end if

	if (myid == 0 ) then
        !...output the errors in each iteration
         write(6,102) iit,res_l,del_l
         write(7,102) iit,res_l,del_l
	end if
      enddo
	if (myid ==0) then
      write(*,'("  maximum fluid velocity (x dir) = ",f13.5)') maxval(d(1:nsd,:))
	end if
